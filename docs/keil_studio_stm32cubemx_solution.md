## Keil Studio for VS Code

- [Using STM32 devices with Keil Studio for Visual Studio Code](https://community.st.com/t5/developer-news/using-stm32-devices-with-keil-studio-for-visual-studio-code/ba-p/873652)
- [github.com | Open-CMSIS-Pack | csolution-examples | CubeMX](https://github.com/Open-CMSIS-Pack/csolution-examples/tree/main/CubeMX)

### Creating a new csolution project   for device STM32F429ZITx 

- This guide assumes **VS Code** is already configured for **Arm Keil Studio CMSIS solutions** as detailed in document [Arm Keil Studio Pack for Visual Studio Code](./Keil_Studio_for_VS_Code.md).

- Click on the **CMSIS circle tick** icon on the the left hand bar, hereafter refered to as the **CMSIS View**
- Click **Create Solution**
- Click on the down arrow below **Target Device**
- Click in the **Search** bar and type your device part number number i.e **STM32F429ZITx**
- When found in the list, click on blue **Select** button.
-  Click on the down arrow below **Templates, Reference Applications, and Examples**
- Under **Local | Templates** click on **CubeMX Basic solution**
- Update **Solution Sub Folder** and select a **Solution Base Folder**.
- Click on the blue **Create** button
- A number of additional tools may now be downloaded. Wait for the the bottom blue bar to display **Arm Tools:5**
- When asked to activate licence just click **non-commercial free of charge**
- You may see the following in the **PROBLEMS** tab.
```bash
! CubeMX.csoultion.yml 1
cgen file was not found, run generator 'CubeMX' for context 'CubeMX.Debug+STM32F429ZITx' csolution....
``` 
- This is saying you need run **STM32CubeMX** to config the target device.

### STM32CubeMX

- Invoke **STM32CubeMX** directly in the **CMSIS View** from the component **Device:CubeMX**
- Click on the cog icon labelled **Run Configuration Generator**
- Alternatively use the VS Code TERMINAL tab and paste the following command
```bash
csolution CubeMX.csolution.yml run --generator CubeMX --context-set
```
- **STM32CubeMX** will now be started.
- Configure the device as required.

### STM32CubeMX target device configurations (Arm 6 Compiler)
- With **STM32CubeMX** open
- In the **Pinout & Configuration** tab
- Select **Categories > System Core > RCC**
- Update: **High Speed Clock (HSE)** to **Crystal/Ceramic Resonator**
- Select **Categories > System Core > SYS**
- Update **Debug** to **Serial Wire**
- Click on **Clock Configuration** tab
- Update the clock configuration as detailed in document [180Mhz clock setup](./180mhz_clock_setup.md)
- Click on **Project Manager** tab.
- Notice that **Toolchain / IDE** is set to **MDK-ARM**
- By default thsi toolchain uses **Arm Compiler 6 (AC6)**. 
- If you wish to use the **GCC** compiler follow the steps detailed [below](#stm32cubemx-target-device-configurations-gcc-compiler).
- Click on left hand tab: **Code Generator*8
- Tick box **Copy only the nessary library files**.
- Click on **GENERATE CODE*8
- Return to **VS Code**, where the project is updated.

### STM32CubeMX target device configurations (GCC compiler)
- [Link to referenced material](https://github.com/Open-CMSIS-Pack/csolution-examples/tree/main/CubeMX)
- By default the project **Toolchain / IDE** is set to **MDK-ARM** this uses the **Arm Compiler 6 (AC6)**. 
- Using **STM32CubeMX** the compiler can be reconfigured for the **GCC** compiler. 
- To configure it for the **GCC** compiler execute these steps:
- Edit the file **CubeMX.csolution.yml** change **compiler:** to **GCC**.
- Then launch **STM32CubeMX** with this **CMSIS-Toolbox** command:
```bash
csolution CubeMX.csolution.yml run --generator CubeMX --context-set
```
- In STM32CubeMX:
- Open from the menu Project Manager - Project - Toolchain/IDE:
- Select **STM32CubeIDE** and disable Generate Under Root. This toolcahin uses **GCC** by default.
- Click **GENERATE CODE** to recreate the CubeMX generated files for the GCC compiler.
- Return to **VS Code**, where the project is now updated.
- In the file **CubeMX.cproject.yml**, update **linker:** node to reference the GCC linker script generated by CubeMX. 
```yml
  linker:
    - script: ./STM32CubeMX/STM32F429ZITx/STM32CubeMX/STM32CubeIDE/STM32F429ZITX_FLASH.ld
```
- Using the Command Palette (Ctrl Shift P)
- Begin typing: arm tools
- Then select: **Arm Tools: Configure Arm Tools Environment**
- A new tab should open
- Scroll down to find **GCC compiler for ARM CPUs**
- Select the latest version, i.e **14.3.1** or higher
- Close tab
- The **GCC** compiler should be now be installed and added to the Arm Tools in the VS Code profile.

## Configure the ST-link Debug Adapter

- In the CMSIS view
- Click on cog icon labelled **Manage Solution Settings**
- Under label **Debug Adapter for STM32F429ZITx**
- Select dropdown and click on **ST-link@pyOCD**
- File **CubeMX.csolution.yml** will now be updated.
- Depending on the ST-link debug adpters firmware a update may be required before it can be used. See document [Updating St-link firmware]()

## Adding new source files to project
- Add a new source file at the root level of project, i.e the same level as many files labelled **CubeMX.** like **CubeMX.cbuild-idx.yml** etc.
- Open for editing file **CubeMX.cproject.yml**
- At the bottom of the file at the following yaml syntax:
```yaml
  groups:
    - group: Source Files
      files:
        - file: ./asm_func.s
```
- Change the source files name as required.
- Multiple files can be added on a new line.
```yaml
  groups:
    - group: Source Files
      files:
        - file: ./filename1.c
        - file: ./filename2.c
        - file: ./filename3.c
```
- When the project was generated, the entry point `main.c` file will have been created at `STM32CubeMX\STM32F429ZITx\STM32CubeMX\Src\main.c` . Update this file accordingly to use the additional source files.
